<!DOCTYPE html>
<html>
  <head>
    <title>AJAX Method Callbacks and Omegle Voyeur Update - Zero Wind :: Jamie Wong</title>
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <link rel="stylesheet" media="screen" href="/stylesheets/screen.css" type="text/css" />
    <link rel="stylesheet" media="screen" href="/stylesheets/prettify.css" type="text/css" />
    <script type="text/javascript" src="/javascript/prettify.js"></script>

    
    
  </head>

  <body class="bp" onload="prettyPrint()">
    <div class="page-container">
      <div class="page-sidebar">

        <div class="zero-wind">
          <a href="/"><h1 class="site-title">
            Zer√∏ Wind
          </h1></a>
        </div>

        <h2 class='my-name'>Jamie Wong</h2>

        <div class='short-bio'>
          <p>
            I'm a UWaterloo Software Engineering student from Ottawa.
            I'm currently an intern at Facebook.
          </p>
        </div>

        <div class="page-nav">
          <ul>
            <li><a href="/">blog</a></li>
            <li><a href="/resume">resume</a></li>
            <li><a href="https://github.com/phleet">github</a></li>
            <li><a href="http://www.linkedin.com/profile/view?id=71283243">linkedin</a></li>
            <li><a href="http://stackoverflow.com/users/303911/jamie-wong">stack overflow</a></li>
          </ul>
        </div>
      </div>

      <div class="page-content">
        
          <h1 class='page-title'>AJAX Method Callbacks and Omegle Voyeur Update</h1>
        

        
<div class="post-date">
  19 April 2010
</div>


<div class="post">
<p>I finally got back around to updating Omegle Voyeur with the ability to
interfere, and decided to re-implement the whole thing in jQuery while I'm at
it. Since jQuery doesn't come with a built-in method of building classes, I used
<a href="http://www.danwebb.net/2008/1/31/low-pro-for-jquery">lowpro for
jQuery</a>. It's a port of a class building scheme from Prototype. It doesn't do
everything I could have hoped for, but it served most of my needs.</p>

<p>The other thing I implemented was a way of knowing when Omegle is blocking
requests. They have a more robust form of detection now - it isn't just manual
IP ban. Once you request too many things from them too fast, they start
requesting a captcha. Locally, this isn't a problem - I simply embed an iframe
with Omegle in it and provide instructions to the user. Hosted, this is a more
troublesome problem, since the captcha is directed towards an IP, so it must be
responded to from that IP. I have no solution to this problem at the moment, but
I'm going to look into implementing the whole thing using Greasemonkey so this
isn't an issue at all.</p>

<p>For now, you can see the latest version here: <a
href="http://jamie-wong.com/omegle/">Omegle Voyeur</a>.
Don't be surprised if it's down, and please go grab your own copy: <a
href="http://github.com/phleet/Omegle-Voyeur">Omegle-Voyeur @ github</a>.</p>

<p>Now on to the customary technical concept to go along with my own self promotion.</p>

<h1>AJAX Method Callbacks</h1>


<p> While passing functions as arguments is a pretty standard thing among almost
 all languages, attempting to pass methods of specific instances as arguments in
 JavaScript presents an interesting problem. Consider the following:</p>

<pre><code>function car(price) {
    this.price = price;

    this.setPrice = function(price) {
        this.price = price;
    };
}

function pass666(func) {
    func(666);
}

var redcar = new car(2000);
alert(redcar.price);
redcar.setPrice(123);
alert(redcar.price);
pass666(redcar.setPrice);
alert(redcar.price);
</code></pre>

<p>As you might expect, the first two alerts will say 2000 and 123 respectively.
But the last one also says 123. Why?</p>

<p>It all has to do with what <code>this</code> refers to. Both in the initialization of
<code>redcar</code> and the modifier call <code>redcar.setPrice</code>, "this" refers to the instance
of the function car given the identifier name <code>redcar</code>. In the <code>pass666</code>
version, <code>this</code> refers to the function <code>pass666</code>. As a result, it does nothing
to modify the properties of the car because it isn't told anything about
<code>redcar</code>.</p>

<p>One way to fix this is to use a placeholder variable. I used "self". Change the
definition of car to the following yields the desired result.</p>

<pre><code>function car(price) {
  this.price = price;

  var self = this;
  this.setPrice = function(price) {
    self.price = price;
  };
}
</code></pre>

<p>In this example, it's difficult to see why you would ever want to use this in
the first place. The reason I encountered this problem is my need to use
instance methods as callback functions for AJAX calls. Here's an excerpt of the
jQuery version of Omegle Voyeur to see what I'm talking about.</p>

<pre><code>sendQuery: function(target,respFunc) {
  // Send a query to the omegle server
  //log('sending');
  var self = this;
  if (respFunc == null) {
    respFunc = function(self,data) {}
  }
  $.ajax({
    url: 'omegle.php?'+target,
    type: 'GET',
    dataType: 'json',
    success: function(data) {
      respFunc(self,data);
    }
  });
},
</code></pre>

<p>Sending a request to the Omegle server is a very common task in Omegle Voyeur,
so I wanted all the AJAX requests leaving from the same method. This means I
have to accept the callback function as a parameter. I've written all the
callback methods to accept a parameter <code>self</code> which will refer to the instance
of interest.</p>

<p>This aspect is one of the many things that makes Prototype's class system
superior to jQuery's. However, since jQuery makes a lot of other things nicer
and the two libraries don't play together very well, I decided to port over to
jQuery nonetheless. In Prototype, there's a function called <a
href="http://www.prototypejs.org/api/function/bind">bind</a> (not to be confused
with <a href="http://api.jquery.com/bind/">jQuery's bind</a> which does
something completely different,) which solves this problem elegantly.</p>

<p>To fix the redcar problem with the aid of Prototype without having to use a
placeholder variable, you can use bind like so:</p>

<pre><code>function car(price) {
    this.price = price;

    this.setPrice = function(price) {
        this.price = price;
    };
}

function pass666(func) {
    func(666);
}

var redcar = new car(2000);
alert(redcar.price);
redcar.setPrice(123);
alert(redcar.price);

pass666(redcar.setPrice.bind(redcar));

alert(redcar.price);
</code></pre>

<p>The line <code>pass666(redcar.setPrice.bind(redcar));</code> is what makes this work out.
We're explicitly saying that we want <code>setPrice</code> executed from the scope of the
instance.</p>

<p>If I ever have to hire someone for a web development job, I'll be sure to ask
something about this.</p>

</div>

<div class="related post-list">
  <h2>Related Posts</h2>
  <ul class="post-list-ul">
    
      <li>
        <a href="/2011/06/25/complex-asynchronous-queries-in-javascript/">Complex Asynchronous Queries in JavaScript</a>
        <span class='date'>25 June 2011</span>
      </li>
    
      <li>
        <a href="/2011/01/12/hacker-cup-qualification-round-solutions/">Hacker Cup Qualification Round - Solutions</a>
        <span class='date'>12 January 2011</span>
      </li>
    
      <li>
        <a href="/2010/11/17/mechanize-and-uwace-downloader/">Mechanize and UWAce Downloader</a>
        <span class='date'>17 November 2010</span>
      </li>
    
      <li>
        <a href="/2010/10/16/dfas-and-graphviz-dot/">DFAs and Graphviz DOT</a>
        <span class='date'>16 October 2010</span>
      </li>
    
      <li>
        <a href="/2010/09/30/make-your-life-easier-with-gnu-make/">Make your life easier with GNU Make.</a>
        <span class='date'>30 September 2010</span>
      </li>
    
  </ul>
</div>


</div>

      </div>
    </div>
  </body>
</html>
